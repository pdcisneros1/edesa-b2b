// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// USUARIOS (ADMINISTRADORES, STAFF Y CLIENTES FERRETERA B2B)
model User {
  id         String   @id @default(cuid())
  email      String   @unique
  password   String
  name       String?
  role       String   @default("admin") // admin, staff, cliente
  // B2B client fields
  company    String?
  ruc        String?
  phone      String?
  isApproved Boolean  @default(true)  // auto-aprobado; futura: validaci贸n manual
  isBlocked  Boolean  @default(false)
  // Password reset
  resetToken       String?   // Token 煤nico para reset de contrase帽a
  resetTokenExpiry DateTime? // Expiraci贸n del token (1 hora)
  // Relaci贸n con 贸rdenes B2B
  orders     Order[]
  // Tracking de conversi贸n
  lastLoginAt      DateTime? // ltima vez que se autentic贸
  sessionCount     Int       @default(0) // Contador de sesiones 煤nicas
  // Relaci贸n con carritos abandonados
  abandonedCarts   AbandonedCart[]
  //  NUEVO: Relaci贸n con carrito activo persistente (multi-dispositivo)
  carts          Cart[]
  // わ NUEVO: Relaci贸n con lista de deseos/favoritos
  wishlist       Wishlist[]
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([email])
  @@index([role])
  @@index([resetToken])
  @@index([lastLoginAt])
}

// CATEGORAS
model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryToCategory", fields: [parentId], references: [id])
  children    Category[] @relation("CategoryToCategory")
  products    Product[]
  order       Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  @@index([slug])
  @@index([parentId])
}

// MARCAS
model Brand {
  id          String    @id @default(cuid())
  name        String
  slug        String    @unique
  logo        String?
  description String?
  products    Product[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([slug])
}

// PRODUCTOS
model Product {
  id               String                 @id @default(cuid())
  sku              String                 @unique
  name             String
  slug             String                 @unique
  description      String                 @db.Text
  shortDescription String?
  price            Float
  wholesalePrice   Float?    // Precio mayorista para ferreter铆as B2B
  compareAtPrice   Float?
  costPrice        Float?
  stock            Int                    @default(0)
  // Inventario Inteligente
  safetyStock      Int?  // Stock de seguridad (manual o sugerido)
  reorderPoint     Int?  // Punto de reorden (cuando alcanzar para ordenar)
  reorderQuantity  Int?  // Cantidad a ordenar cuando se alcanza punto de reorden
  leadTimeDays     Int?  @default(7) // D铆as de espera del proveedor
  averageMonthlySales Float? // Promedio ventas/mes (calculado autom谩ticamente)
  categoryId       String
  category         Category               @relation(fields: [categoryId], references: [id])
  brandId          String?
  brand            Brand?                 @relation(fields: [brandId], references: [id])
  images           ProductImage[]
  specifications   ProductSpecification[]
  cartItems        CartItem[]
  orderItems       OrderItem[]
  technicalSheet   String?
  isActive         Boolean                @default(true)
  isFeatured       Boolean                @default(false)
  isNew            Boolean                @default(false)
  purchaseItems    PurchaseOrderItem[]
  promotions       PromotionProduct[]
  wishlistItems    Wishlist[]  // わ NUEVO: Relaci贸n con listas de deseos
  createdAt        DateTime               @default(now())
  updatedAt        DateTime               @updatedAt

  @@index([slug])
  @@index([sku])
  @@index([categoryId])
  @@index([brandId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([isNew])
}

// IMGENES DE PRODUCTOS
model ProductImage {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  url       String
  alt       String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

// ESPECIFICACIONES DE PRODUCTOS
model ProductSpecification {
  id        String   @id @default(cuid())
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  key       String
  value     String
  order     Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
}

// CARRITOS (Soporte para User B2B y Customer guest)
model Cart {
  id         String     @id @default(cuid())
  //  NUEVO: Soporte para usuarios B2B autenticados
  userId     String?
  user       User?      @relation(fields: [userId], references: [id], onDelete: Cascade)
  // Soporte para clientes guest (mantenido para compatibilidad)
  customerId String?
  customer   Customer?  @relation(fields: [customerId], references: [id])
  items      CartItem[]
  subtotal   Float      @default(0)
  total      Float      @default(0)
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt

  @@index([userId])
  @@index([customerId])
}

// ITEMS DEL CARRITO
model CartItem {
  id        String   @id @default(cuid())
  cartId    String
  cart      Cart     @relation(fields: [cartId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
  subtotal  Float
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([cartId])
  @@index([productId])
}

// CLIENTES (Usado solo para carrito y direcciones - NO para 贸rdenes)
model Customer {
  id              String    @id @default(cuid())
  firstName       String
  lastName        String
  email           String    @unique
  phone           String
  company         String?
  taxId           String?
  isBusinessClient Boolean   @default(false)
  passwordHash    String
  addresses       Address[]
  carts           Cart[]
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([email])
}

// DIRECCIONES
model Address {
  id                 String     @id @default(cuid())
  customerId         String
  customer           Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  firstName          String
  lastName           String
  company            String?
  address1           String
  address2           String?
  city               String
  state              String
  postalCode         String
  country            String     @default("Ecuador")
  phone              String
  isDefault          Boolean    @default(false)
  // Relations removed from Address side as Order now snapshots data

  createdAt          DateTime   @default(now())
  updatedAt          DateTime   @updatedAt

  @@index([customerId])
}

// RDENES (B2B - SIEMPRE VINCULADAS A USER)
model Order {
  id              String      @id @default(cuid())
  orderNumber     String      @unique
  // FK obligatorio a User (B2B cerrado)
  userId          String
  user            User        @relation(fields: [userId], references: [id], onDelete: Restrict)
  items           OrderItem[]

  // Montos
  subtotal        Float
  tax             Float
  shipping        Float       @default(0)
  total           Float

  // Estado y pago
  status          OrderStatus @default(pendiente_pago)
  paymentMethod   String?     // transferencia | tarjeta | efectivo

  // Snapshot del cliente al momento de la compra
  customerName    String
  customerEmail   String
  customerPhone   String?
  customerCompany String?
  customerTaxId   String?

  // Snapshot de direcci贸n de env铆o
  shippingStreet   String
  shippingCity     String
  shippingProvince String
  shippingZipCode  String
  shippingCountry  String      @default("Ecuador")

  // M茅todo de env铆o y notas
  shippingMethod  String?
  notes           String?     @db.Text

  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  @@index([orderNumber])
  @@index([userId])
  @@index([status])
  @@index([createdAt])
}

// ITEMS DE ORDEN
model OrderItem {
  id          String   @id @default(cuid())
  orderId     String
  order       Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     Product  @relation(fields: [productId], references: [id])
  productName String
  productSku  String
  quantity    Int
  unitPrice   Float    // precio unitario al momento de la compra (snapshot)
  subtotal    Float
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([orderId])
  @@index([productId])
}

// ENUM DE ESTADOS DE ORDEN
// Valores en espa帽ol que coinciden con src/types/sales.ts OrderStatus
enum OrderStatus {
  pendiente_pago
  pagado
  en_proceso
  enviado
  entregado
  cancelado
}

// PROVEEDORES
model Supplier {
  id        String   @id @default(cuid())
  name      String
  contact   String?
  email     String?
  phone     String?
  orders    PurchaseOrder[]
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// RDENES DE COMPRA (INGRESO A BODEGA)
model PurchaseOrder {
  id              String              @id @default(cuid())
  invoiceNumber   String              @unique // N煤mero de factura f铆sica
  supplierId      String
  supplier        Supplier            @relation(fields: [supplierId], references: [id])
  date            DateTime            @default(now())
  status          PurchaseOrderStatus @default(PENDING)
  items           PurchaseOrderItem[]
  totalAmount     Float               @default(0)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([invoiceNumber])
  @@index([supplierId])
  @@index([status])
}

model PurchaseOrderItem {
  id              String        @id @default(cuid())
  purchaseOrderId String
  purchaseOrder   PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  productId       String
  product         Product       @relation(fields: [productId], references: [id])
  quantity        Int
  unitCost        Float         // Costo unitario al momento de compra
  totalCost       Float
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  @@index([purchaseOrderId])
  @@index([productId])
}

enum PurchaseOrderStatus {
  PENDING
  RECEIVED
  CANCELLED
}

// PROMOCIONES
model Promotion {
  id                  String             @id @default(cuid())
  name                String             // Nombre de la promoci贸n
  description         String?            @db.Text

  // Descuento
  discountType        DiscountType       // 'percentage' o 'fixed'
  discountValue       Float              // Porcentaje (0-100) o monto fijo en USD

  // Validez - ambas opciones disponibles
  validFrom           DateTime?          // Fecha inicio (opcional)
  validUntil          DateTime?          // Fecha fin (opcional)
  daysFromActivation  Int?               // D铆as desde activaci贸n (opcional)

  // Control
  isActive            Boolean            @default(true)
  isManuallyDisabled  Boolean            @default(false)  // Desactivaci贸n manual

  // Relaci贸n M:N con productos
  products            PromotionProduct[]

  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt

  @@index([isActive])
  @@index([validFrom, validUntil])
}

model PromotionProduct {
  id           String    @id @default(cuid())
  promotionId  String
  productId    String
  activatedAt  DateTime  @default(now())  // Para calcular d铆as desde activaci贸n

  promotion    Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)
  product      Product   @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([promotionId, productId])
  @@index([productId])
  @@index([promotionId])
}

enum DiscountType {
  percentage
  fixed
}

// ============================================================================
// TRACKING DE CONVERSIN Y ABANDONO DE CARRITO
// ============================================================================

// CARRITOS ABANDONADOS (para recovery emails y analytics)
model AbandonedCart {
  id        String   @id @default(cuid())
  userId    String?  // Opcional: puede ser guest o autenticado
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Datos del carrito
  items     Json     // Array de { productId, quantity, price, name }
  subtotal  Float
  total     Float

  // Tracking
  status    AbandonedCartStatus @default(ACTIVE)
  createdAt DateTime            @default(now())
  updatedAt DateTime            @updatedAt

  // Email recovery
  recoveryEmailSent   Boolean   @default(false)
  recoveryEmailSentAt DateTime?
  convertedToOrderId  String?   // Si se recuper贸, ID de la orden

  // Info adicional para recovery
  customerEmail String?
  customerName  String?

  @@index([userId])
  @@index([status])
  @@index([createdAt])
  @@index([recoveryEmailSent])
}

enum AbandonedCartStatus {
  ACTIVE      // Carrito activo (< 1 hora)
  ABANDONED   // Carrito abandonado (> 1 hora, < 7 d铆as)
  RECOVERED   // Convertido en orden
  EXPIRED     // Muy antiguo (> 7 d铆as)
}

// ============================================================================
// LISTAS DE DESEOS / FAVORITOS (Solo usuarios autenticados)
// ============================================================================

model Wishlist {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  // Un usuario solo puede tener un producto una vez en su wishlist
  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
}
